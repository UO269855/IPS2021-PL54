<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DemoJdbc.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">samples-test-dev</a> &gt; <a href="index.source.html" class="el_package">giis.demo.jdbc</a> &gt; <span class="el_source">DemoJdbc.java</span></div><h1>DemoJdbc.java</h1><pre class="source lang-java linenums">package giis.demo.jdbc;
import java.sql.*;
import java.util.List;
import java.util.Map;

import org.apache.commons.dbutils.DbUtils;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanListHandler;
import org.apache.commons.dbutils.handlers.MapListHandler;
import org.apache.commons.dbutils.handlers.ScalarHandler;
import org.apache.log4j.Logger;

import giis.demo.util.UnexpectedException;

/**
 * Ejemplos de acceso a una base de datos con conexion JDBC y base de datos Sqlite
 */
<span class="nc" id="L18">public class DemoJdbc {</span>
	//informacion de conexion a la base de datos utilizada
	public static final String DRIVER=&quot;org.sqlite.JDBC&quot;;
	public static final String URL=&quot;jdbc:sqlite:DemoDB.db&quot;;
	//datos para SQLServer:
	//com.microsoft.sqlserver.jdbc.SQLServerDriver
	//jdbc:sqlserver://localhost:1433;DatabaseName=******;user=******;password=******
<span class="nc" id="L25">	private Logger log=Logger.getLogger(DemoJdbc.class);</span>
	
	/**
	 * Demo basico de acceso a bases de datos, parte 1: conexiones, consultas y manejo basico de excepciones
	 */
	public void demo1Basic() {
		try {
			//instalacion de la clase que contiene al driver (basta con hacerlo una vez)
			//el driver (en este caso sqljdbc.jar ha sido descargado y puesto en el classpath)
			//Esto normalmente no es necesario pues a partir de JDBC 4.0 los drivers se autoregistran
<span class="nc" id="L35">			Class.forName(DRIVER);</span>
			//Definicion de la cadena de conexion, especifica para cada gestor de base de datos
<span class="nc" id="L37">			String connString=URL;</span>

			//Ejecuta acciones de actualizacion: insertar datos en una tabla
<span class="nc" id="L40">			Connection cn=DriverManager.getConnection(connString); //NOSONAR</span>
<span class="nc" id="L41">			Statement stmt = cn.createStatement(); //NOSONAR</span>
			try {
<span class="nc" id="L43">				stmt.executeUpdate(&quot;drop table if exists test&quot;);</span>
<span class="nc" id="L44">			} catch (SQLException e) {</span>
				//ignora excepcion, que se causara si la tabla no existe en la bd (p.e. al ejecutar la primera vez)
<span class="nc" id="L46">			}</span>
<span class="nc" id="L47">			stmt.executeUpdate(&quot;create table test(id int not null, id2 int, text varchar(32))&quot;);</span>
<span class="nc" id="L48">			stmt.executeUpdate(&quot;insert into test(id,id2,text) values(1,null,'abc')&quot;);</span>
<span class="nc" id="L49">			stmt.executeUpdate(&quot;insert into test(id,id2,text) values(2,9999,'xyz')&quot;);</span>
<span class="nc" id="L50">			stmt.close(); //no olvidar cerrar estos objetos</span>
<span class="nc" id="L51">			cn.close();</span>

			//Consulta todas las filas a partir del resultado de una query SQL
<span class="nc" id="L54">			cn=DriverManager.getConnection(connString); //NOSONAR</span>
<span class="nc" id="L55">			stmt=cn.createStatement(); //NOSONAR</span>
<span class="nc" id="L56">			ResultSet rs=stmt.executeQuery(&quot;select id,id2,text from test order by id desc&quot;); //NOSONAR</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">			while (rs.next()) { //cada vez que se llama rs.next() avanza el cursor a una fila</span>
<span class="nc" id="L58">				int id=rs.getInt(1);        //obtencion de un valor con un tipo de dato especificado, indicando el numero de columna</span>
<span class="nc" id="L59">				String id2=rs.getString(2); //obtencion de un valor como string, aunque sea entero</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">				if (rs.wasNull())           //comprobacion de valores nulos (respecto del ultimo get realizado)</span>
<span class="nc" id="L61">					id2=&quot;NULO&quot;;			    //  si es nulo puedo hacer un tratamiento especial, en este caso poner un valor</span>
<span class="nc" id="L62">				String text=rs.getString(&quot;text&quot;); //obtencion de un valor indicando el nombre de la columna</span>
<span class="nc" id="L63">				log.info(&quot;demo1Basic: &quot;+id+&quot; &quot;+id2+&quot; &quot;+text);</span>
<span class="nc" id="L64">			}</span>
<span class="nc" id="L65">			rs.close();</span>
<span class="nc" id="L66">			stmt.close();</span>
<span class="nc" id="L67">			cn.close();</span>
			//varios de los metodos anteriores causan excepciones que se capturan aqui, normalmente habra que tratar 
			//cada excepcion en cada caso
<span class="nc" id="L70">		} catch (ClassNotFoundException | SQLException e) { </span>
			//Ojo, no dejar pasar las excepciones (no limitarse a dejar el codigo autoegenerado por Eclipse haciendo solo printStackTrace)
<span class="nc" id="L72">			throw new UnexpectedException(e); //Es mas habitual usar excepciones propias de la aplicacion (DemoException que RuntimeException)</span>
<span class="nc" id="L73">		}</span>
<span class="nc" id="L74">	}</span>

	/**
	 * Creacion de tabla para los ejemplos a partir del segundo
	 */
	private void createTable() {
		//el try with resources nos va a asegurar que los objetos cn y stmt siempre se cierran haya o no excepcion
<span class="nc bnc" id="L81" title="All 2 branches missed.">		try (Connection cn=DriverManager.getConnection(URL)) { //NOSONAR</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">			try (Statement stmt = cn.createStatement()) {</span>
<span class="nc" id="L83">				stmt.executeUpdate(&quot;drop table if exists test&quot;);</span>
<span class="nc" id="L84">				stmt.executeUpdate(&quot;create table test(id int not null, id2 int, text varchar(32))&quot;);</span>
<span class="nc" id="L85">				stmt.executeUpdate(&quot;insert into test(id,id2,text) values(1,null,'abc')&quot;);</span>
<span class="nc" id="L86">				stmt.executeUpdate(&quot;insert into test(id,id2,text) values(2,9999,'xyz')&quot;);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">			}</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">		} catch (SQLException e) {</span>
			//Ojo, no dejar pasar las excepciones (no limitarse a dejar el codigo autoegenerado por Eclipse haciendo solo printStackTrace)
<span class="nc" id="L90">			throw new UnexpectedException(e); //Es mas habitual usar excepciones propias de la aplicacion</span>
<span class="nc" id="L91">		}</span>
<span class="nc" id="L92">	}</span>
	/**
	 * Demo basico de acceso a bases de datos, parte 2:
	 * Uso de he try-with-resources Statement para manejar excepciones y cerrar de forma segura los recursos
	 * (Las mismas acciones que el anterior pero con mejor control de excepciones) y consultas con parametros
	 */
	public void demo2TryWithResources() {
<span class="nc" id="L99">		createTable();</span>
		//En un mismo try se pueden poner diferentes sentencias que crean objetos que gestionan recursos que hay que cerrar
<span class="nc bnc" id="L101" title="All 6 branches missed.">		try (Connection cn=DriverManager.getConnection(URL); //NOSONAR</span>
<span class="nc" id="L102">				Statement stmt=cn.createStatement();</span>
<span class="nc" id="L103">				ResultSet rs=stmt.executeQuery(&quot;select id,id2,text from test order by id desc&quot;)) {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">			while (rs.next()) { //cada vez que se llama rs.next() avanza el cursor a una fila</span>
<span class="nc" id="L105">				int id=rs.getInt(1);        //obtencion de un valor con un tipo de dato especificado, indicando el numero de columna</span>
<span class="nc" id="L106">				String id2=rs.getString(2); //obtencion de un valor como string, aunque sea entero</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">				if (rs.wasNull())           //comprobacion de valores nulos (respecto del ultimo get realizado)</span>
<span class="nc" id="L108">					id2=&quot;NULO&quot;;			    //  si es nulo puedo hacer un tratamiento especial, en este caso poner un valor</span>
<span class="nc" id="L109">				String text=rs.getString(&quot;text&quot;); //obtencion de un valor indicando el nombre de la columna</span>
<span class="nc" id="L110">				log.info(&quot;demo2TryWithResources: &quot;+id+&quot; &quot;+id2+&quot; &quot;+text);</span>
<span class="nc" id="L111">			}</span>
<span class="nc bnc" id="L112" title="All 6 branches missed.">		} catch (SQLException e) {</span>
<span class="nc" id="L113">			throw new UnexpectedException(e);</span>
<span class="nc" id="L114">		}</span>
<span class="nc" id="L115">	}</span>
	/**
	 * Demo de acceso a bases de datos, parte 3: Consultas con parametros.
	 * Permite definir consultas sql donde alguno de los valores no son conocidos de moemnto (?).
	 * Estos valores se instancian en el momento de la ejecucion.
	 */
	public void demo3Parameters() {
<span class="nc" id="L122">		createTable();</span>
		//En vez de crear un Statement y pasar el sql en executeQuery,
		//se crea un PreparedStatement con el sql, luego se le ponen los parametros y finalmente se ejecuta
<span class="nc bnc" id="L125" title="All 4 branches missed.">		try (Connection cn=DriverManager.getConnection(URL); //NOSONAR</span>
<span class="nc" id="L126">			PreparedStatement pstmt=cn.prepareStatement(&quot;select id,id2,text from test where id&gt;=?&quot;)) {</span>
<span class="nc" id="L127">			pstmt.setInt(1, 2); // pone valor 2 en el primer (y unico) parametro</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">			try (ResultSet rs=pstmt.executeQuery()) {</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L130">					log.info(&quot;demo3Parameters: &quot;+rs.getInt(1)+&quot; &quot;+rs.getInt(2)+&quot; &quot;+rs.getString(3));</span>
				}
<span class="nc bnc" id="L132" title="All 2 branches missed.">			}</span>
<span class="nc bnc" id="L133" title="All 4 branches missed.">		} catch (SQLException e) {</span>
<span class="nc" id="L134">			throw new UnexpectedException(e);</span>
<span class="nc" id="L135">		}</span>
		//de forma similar se pueden ejecutar acciones de actualizacion sobre el PreparedStatement
<span class="nc" id="L137">	}</span>
	/**
	 * Demo de acceso a bases de datos, parte 3: Uso de Apache commons-dbutils.
	 * Las librerias Apache Commons https://commons.apache.org/ incluyen muchos componentes
	 * que facilitan y amplian funcionalidades estandar en Java.
	 * Una de ellas es DbUtils que permite simplificar el acceso y recuperacion de datos procedentes 
	 * de una base de datos que se muestra en este ejemplo:
	 * El acceso a la base de datos con DbUtils se basa en el uso de objetos QueryRunner que 
	 * realizan las consultas y handlers que indican como se manejaran los datos. 
	 */
	public void demo4DbUtils() {
<span class="nc" id="L148">		createTable();</span>
		//El siguiente ejemplo define un handler que obtendra los resultados de una consulta
		//como una lista de objetos (POJOs/Beans). Comparar este codigo con lo que seria necesario
		//para leer un resultset y poner los resultados en los objetos.
<span class="nc" id="L152">		Connection conn=null;</span>
		List&lt;Entity&gt; pojoList; //lista de objetos que seran devueltos por la query
		try {
<span class="nc" id="L155">			conn=DriverManager.getConnection(URL); //NOSONAR</span>
			//declara el handler que permitira obtener la lista de objetos de la clase indicada
<span class="nc" id="L157">			BeanListHandler&lt;Entity&gt; beanListHandler=new BeanListHandler&lt;&gt;(Entity.class);</span>
			//Declara el runner que ejecutara la consulta
<span class="nc" id="L159">			QueryRunner runner=new QueryRunner();</span>
			//ejecuta la consulta, el ultimo argumento es el parametro (lista variable si hay mas de uno)
<span class="nc" id="L161">			String sql=&quot;select id,id2,text from test where id&gt;=?&quot;;</span>
<span class="nc" id="L162">			pojoList=runner.query(conn, sql, beanListHandler, 2);</span>
<span class="nc" id="L163">		} catch (SQLException e) {</span>
<span class="nc" id="L164">			throw new UnexpectedException(e);</span>
		} finally {
<span class="nc" id="L166">			DbUtils.closeQuietly(conn); //usar este metodo para facilitar el cierre de conexion de forma mas segura</span>
		}
		//al ejecutarse con el parametro 1 devolvera la unica fila con id&gt;1
<span class="nc bnc" id="L169" title="All 2 branches missed.">		for (Entity item : pojoList)</span>
<span class="nc" id="L170">			log.info(&quot;demo4DbUtils (Bean): &quot;+item.getId()+&quot; &quot;+item.getId2()+&quot; &quot;+item.getText());</span>
		
		//El siguiente ejemplo muestra lo mismo pero usando un MapListHandler que obtiene una lista de maps
		//escrito de forma mas compacta
		List&lt;Map&lt;String,Object&gt;&gt; mapList; //lista de maps que seran devueltos por la query
		try {
<span class="nc" id="L176">			conn=DriverManager.getConnection(URL); //NOSONAR</span>
<span class="nc" id="L177">			String sql=&quot;select id,id2,text from test where id&gt;?&quot;;</span>
<span class="nc" id="L178">			mapList=new QueryRunner().query(conn, sql, new MapListHandler(),1);</span>
<span class="nc" id="L179">		} catch (SQLException e) {</span>
<span class="nc" id="L180">			throw new UnexpectedException(e);</span>
		} finally {
<span class="nc" id="L182">			DbUtils.closeQuietly(conn);</span>
		}
<span class="nc bnc" id="L184" title="All 2 branches missed.">		for (Map&lt;String,Object&gt; item : mapList)</span>
<span class="nc" id="L185">			log.info(&quot;demo4DbUtils (Map): &quot;+item.get(&quot;id&quot;)+&quot; &quot;+item.get(&quot;id2&quot;)+&quot; &quot;+item.get(&quot;text&quot;));</span>
		
		//Otro ejemplo que obtiene un unico valor escalar.
<span class="nc" id="L188">		Integer cnt=null;</span>
		try {
<span class="nc" id="L190">			conn=DriverManager.getConnection(URL); //NOSONAR</span>
<span class="nc" id="L191">			String sql=&quot;select count(*) as cnt from test where id&gt;?&quot;;</span>
<span class="nc" id="L192">			cnt=new QueryRunner().query(conn, sql, new ScalarHandler&lt;Integer&gt;(), 0);</span>
<span class="nc" id="L193">		} catch (SQLException e) {</span>
<span class="nc" id="L194">			throw new UnexpectedException(e);</span>
		} finally {
<span class="nc" id="L196">			DbUtils.closeQuietly(conn);</span>
		}
<span class="nc" id="L198">		log.info(&quot;demo4DbUtils (Scalar): numero de filas: &quot;+cnt);</span>
		
		//Como se ve en los ejemplos anteriores, el patron es siempre el mismo, 
		//solo cambia el Handler en funcion del tipo de dato que se desea obtener

		//Existen otros tipos de handlers para manejar otros tipos de valores como escalares, arrays o listas,
		//y metodos de QueryRunner para sentencias sql de actualizacion
		//Ver mas documentacion:
		//http://commons.apache.org/proper/commons-dbutils/apidocs/index.html
		//https://commons.apache.org/proper/commons-dbutils/examples.html
<span class="nc" id="L208">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>